A Dive into Building a Decentralized Identity Management on zkSync

## Table of Contents:

1. [Introduction](#introduction)
2. [Project Setup](#project-setup)
3. [Smart Contract Overview](#smart-contract-development)
4. [Struct](#smart-contract-struct)
5. [Mapping and Events](#mapping-and-events)
6. [Identity Creation](#identity-creation)
7. [Update Identity](#update-identity)
8. [Delete Identity](#delete-identity)
9. [Verify Identity](#verify-identity)
10. [Revoke Identity](#revoke-identity)
10. [Retrieve Identity](#retrieve-identity)
10. [Retrieve Identity](#retrieve-identity)
11. [Check Identity Verification](#check-identity-verification)
12. [Log Identity Actions](#log-identity-actions)
13. [Complete Code](#complete-code)
14. [Writing Tests](#writing-tests)
15. [Compiling and deploying](#compiling-and-deploying)

## Introduction

A decentralized identity management has emerged as a pivotal component for enhancing security, privacy, and user control. However, zkSync, a Layer 2 scaling solution for Ethereum, offers a promising avenue for addressing these challenges. By leveraging zero-knowledge proofs, zkSync provides high throughput and low-cost transactions while maintaining the security and decentralization of the Ethereum network.

In this article, we will delve into the intricacies of building a decentralized identity management system on zkSync and a step-by-step guide to implementing a robust identity management solution on zkSync era. This includes smart contract development, writing tests and deployment zkSync sepolia testnet.

## Project Setup

To setup the project, we will scaffold it with [zkSync cli](https://docs.zksync.io/build/tooling/zksync-cli/commands/create.html#contracts) for easy set up.

Head over to your command prompt or terminal and run the code below:

`npx zksync-cli create`

You will be prompted to enter your project's name. You can enter your desired project's name, in our case `IdentityManagement`.

Next, you will be prompted to select the type of project. Select `Contracts` and proceed. 

After that, select `Ethers V6` as ethereum framework and select `Hardhat + Solidity` as Template.

You will be prompted to enter `private key` or set it later. For this tutorial,leave it blank and continue.

Finally, select your desired package manage to begin installations.

This will create a new zkSync era project named `IdentityManagement`. Some examples contracts,tests and deployment will be generated by default. However, for the purposes of this tutorial, we don't need the example contracts related files. So, proceed by removing all the files inside the /contracts , /test folders manually or by running the following commands:

`cd IdentityManagement `
`rm -rf ./contracts/*`
`rm -rf ./test/*`

Finally, create a file named `IdentityManagement.sol` inside your `contracts` folder.

## Smart Contract Overview

The Identity `identityManagemen` smart contract serves as the backbone of our decentralized identity management system. This contract, written in Solidity, allows users to manage their identities securely on the zkSync network. 

Below is the the complete smart contract code for this project :

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract IdentityVerification {

    /**
     * @dev Struct representing an identity.
     * @param user The address of the user.
     * @param name The name of the user.
     * @param email The email of the user.
     * @param isVerified Indicates if the identity is verified.
     * @param exists Indicates if the identity exists.
     */
    struct Identity {
        address user;
        string name;
        string email;
        bool isVerified;
        bool exists;
    }

    /// Mapping from user address to their identity
    mapping(address => Identity) public identities;

    /// Event emitted when a new identity is added
    event IdentityAdded(address indexed user, string name, string email);

    /// Event emitted when an identity is updated
    event IdentityUpdated(address indexed user, string name, string email);

    /// Event emitted when an identity is deleted
    event IdentityDeleted(address indexed user);

    /// Event emitted when an identity is verified
    event IdentityVerified(address indexed user);

    /// Event emitted when an identity is revoked
    event IdentityRevoked(address indexed user);

    /// Event emitted when an identity-related action is logged
    event IdentityActionLogged(string action);

    /**
     * @dev Adds a new identity for the caller.
     * @param _name The name of the user.
     * @param _email The email of the user.
     */
    function addIdentity(string memory _name, string memory _email) public {
        require(!identities[msg.sender].exists, "Identity already exists");
        identities[msg.sender] = Identity({
            user: msg.sender,
            name: _name,
            email: _email,
            isVerified: false,
            exists: true
        });
        emit IdentityAdded(msg.sender, _name, _email);
        logIdentityAction("Identity Added");
    }

    /**
     * @dev Updates the identity of the caller.
     * @param _name The new name of the user.
     * @param _email The new email of the user.
     */
    function updateIdentity(string memory _name, string memory _email) public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].name = _name;
        identities[msg.sender].email = _email;
        emit IdentityUpdated(msg.sender, _name, _email);
        logIdentityAction("Identity Updated");
    }

    /**
     * @dev Deletes the identity of the caller.
     */
    function deleteIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        delete identities[msg.sender];
        emit IdentityDeleted(msg.sender);
        logIdentityAction("Identity Deleted");
    }

    /**
     * @dev Verifies the identity of the caller.
     */
    function verifyIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].isVerified = true;
        emit IdentityVerified(msg.sender);
        logIdentityAction("Identity Verified");
    }

    /**
     * @dev Revokes the verification of the identity of the caller.
     */
    function revokeIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].isVerified = false;
        emit IdentityRevoked(msg.sender);
        logIdentityAction("Identity Revoked");
    }

    /**
     * @dev Retrieves the identity of a given user.
     * @param _user The address of the user.
     * @return The identity of the user.
     */
    function getIdentity(address _user) public view returns (Identity memory) {
        require(identities[_user].exists, "Identity does not exist");
        return identities[_user];
    }

    /**
     * @dev Checks if a given user's identity is verified.
     * @param _user The address of the user.
     * @return True if the user's identity is verified, false otherwise.
     */
    function isIdentityVerified(address _user) public view returns (bool) {
        require(identities[_user].exists, "Identity does not exist");
        return identities[_user].isVerified;
    }

    /**
     * @dev Logs an identity-related action.
     * @param action The action to log.
     */
    function logIdentityAction(string memory action) internal {
        emit IdentityActionLogged(action);
    }
}
```

## Smart Contract Struct

The `Identity` struct encapsulates user information, comprising the following fields:

- **`address user`**: address uniquely identifying the user.
- **`string name`**: User's name.
- **`string email`**: User's email address.
- **`bool isVerified`**: Indicates if the user's identity has been verified.
- **`bool exists`**: Indicates if the identity record exists in the system.

This struct provides a structured way to manage and store user identities, ensuring efficient and secure operations like adding, updating, verifying, and deleting identities within the contract.

## Mapping and Events

The mapping, `identities`, link user addresses to their respective `Identity` structs, facilitating efficient management of user identities.

1. **`IdentityAdded`**: Emitted when a new identity is added.
2. **`IdentityUpdated`**: Emitted when an existing identity is updated.
3. **`IdentityDeleted`**: Emitted when an identity is deleted.
4. **`IdentityVerified`**: Emitted when an identity is verified.
5. **`IdentityRevoked`**: Emitted when an identity's verification is revoked.
6. **`IdentityActionLogged`**: Emitted when any identity-related action is logged.

## Identity Creation

```solidity
 function addIdentity(string memory _name, string memory _email) public {
        require(!identities[msg.sender].exists, "Identity already exists");
        identities[msg.sender] = Identity({
            user: msg.sender,
            name: _name,
            email: _email,
            isVerified: false,
            exists: true
        });
        emit IdentityAdded(msg.sender, _name, _email);
        logIdentityAction("Identity Added");
    }
```

The `addIdentity` function allows a user to create a new identity. It performs the following actions:

1. Checks that the user's identity does not already exist.
2. Creates a new `Identity` struct for the user with the provided name and email, setting `isVerified` to `false` and `exists` to `true`.
3. Updates the `identities` mapping with the new identity.
4. Emits the `IdentityAdded` event.
5. Logs the action "Identity Added" using the `logIdentityAction` function.

## Update Identity

```solidity
  function updateIdentity(string memory _name, string memory _email) public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].name = _name;
        identities[msg.sender].email = _email;
        emit IdentityUpdated(msg.sender, _name, _email);
        logIdentityAction("Identity Updated");
    }
```
The `updateIdentity` function allows a user to update their existing identity's name and email. It performs the following actions:

1. Checks that the user's identity exists.
2. Updates the `name` and `email` fields of the user's existing identity with the provided values.
3. Emits the `IdentityUpdated` event.
4. Logs the action "Identity Updated" using the `logIdentityAction` function.

## Delete identity

```solidity
   function deleteIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        delete identities[msg.sender];
        emit IdentityDeleted(msg.sender);
        logIdentityAction("Identity Deleted");
    }
```
The `deleteIdentity` function allows a user to delete their existing identity. It performs the following functions actions:

1. Checks that the user's identity exists.
2. Deletes the user's identity from the `identities` mapping.
3. Emits the `IdentityDeleted` event.
4. Logs the action "Identity Deleted" using the `logIdentityAction` function.

## Verify Identity

```solidity
  function verifyIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].isVerified = true;
        emit IdentityVerified(msg.sender);
        logIdentityAction("Identity Verified");
    }
```

The `verifyIdentity` function allows a user to verify their identity. It performs the following functions actions :

1. Checks that the user's identity exists.
2. Sets the `isVerified` field of the user's identity to `true`.
3. Emits the `IdentityVerified` event.
4. Logs the action "Identity Verified" using the `logIdentityAction` function.

## Revoke Identity 

```solidity
  function revokeIdentity() public {
        require(identities[msg.sender].exists, "Identity does not exist");
        identities[msg.sender].isVerified = false;
        emit IdentityRevoked(msg.sender);
        logIdentityAction("Identity Revoked");
    }
```

The `revokeIdentity` function allows a user to revoke their identity verification.

1. **Checks that the user's identity exists**.
2. **Sets the `isVerified` field of the user's identity to `false`**, marking it as not verified.
3. **Emits the `IdentityRevoked` event**.
4. **Logs the action "Identity Revoked"** using the `logIdentityAction` function.

## Retrieve Identity

```solidity
 function getIdentity(address _user) public view returns (Identity memory) {
        require(identities[_user].exists, "Identity does not exist");
        return identities[_user];
    }
```
The `getIdentity` function retrieves the identity details for a specified user address:

1. **Checks that the user's identity exists** in the `identities` mapping.
2. **Returns the identity details** for the specified address.

## Check Identity Verification 

```solidity
    function isIdentityVerified(address _user) public view returns (bool) {
        require(identities[_user].exists, "Identity does not exist");
        return identities[_user].isVerified;
    }
```

The `isIdentityVerified` function checks whether a specified user's identity is verified:

1. **Checks that the user's identity exists** in the `identities` mapping.
2. **Returns the verification status** (`true` or `false`) of the specified user's identity.

## Log Identity Actions

```solidity
function logIdentityAction(string memory action) internal {
        emit IdentityActionLogged(action);
    }
```

The `logIdentityAction` function logs an identity-related action:

1. **Emits the `IdentityActionLogged` event** with the provided action string.
2. **Internal function**, meaning it can only be called within the contract itself.



